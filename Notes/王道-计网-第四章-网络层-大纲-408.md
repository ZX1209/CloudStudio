## 4.1 网络层的功能
### 4.1.1 异构网络互联
1. 物理层中继系统
   1. 中继器
   2. 集线器(Hub)
2. 数据链路层中继系统
   1. 网桥
   2. 交换机(Switch)
3. 网络层中继系统
   1. 路由器
4. 网络层以上中继系统
   1. 网关

网络互联通常指用路由器进行网络互联和路由选择


### 4.1.2 路由与转发
路由器主要完成两个功能: 路由选择,分组转发

1. 路由选择,依据算法,动态改变所选择的路由
2. 分组转发,路由器根据转发表将用户的IP数据报从合适的端口转发出去




### 4.1.3 拥塞控制
因出现过量的分组而引起网络性能下降的现象称为拥赛

小于正常吞吐量,轻度拥塞
网络吞吐量随着网络负载的增大而下降,那么网络就可能已经进入拥塞状态
如果网络吞吐量下降到零,那么网络可能已经进入死锁状态

拥堵控制方法有两种
1. 开换控制,静态方法,
2. 闭环控制,及时检测,动态调整


## 4.2 路由算法
### 4.2.1 静态路由与动态路由
静态路由算法 ,又称非自适应路由算法,手动配置
动态路由算法,又称自适应路由算法,算法配置

动态路由算法可分为两类: 距离-向量路由算法,和链路状态路由算法
### 4.2.2 距离-向量路由算法
所有节点都定期地将它们的整个路由选择表传送给所有与之直接相邻的节点,包括
每条路径的目的地(另一节点)
路径的代价(距离)

所有节点都监听从其他节点床来的路由选择信息,并在下列情况下更新它们的路由选择表
1. 被告知一条新路由
2. 有较短距离

每隔节点在每次更新时将它的全部路由发送给所有相邻的节点

可能遇到路由环路问题

RIP 算法 采用跳数作为距离的度量



### 4.2.3 链路状态路由算法
要求每个参与该算法的节点都具有完全的网络拓扑信息
它们执行下述两项任务
1. 主动测试所有邻接节点的状态.共享同一条链接的节点是相邻节点
2. 定期地将链路状态传播给其他节点

一旦链路状态发生bianca,节点就对更新的网络图利用Dijsktra最短路径算法重新计算路由

OSPF算法



### 4.2.4 层次路由
因特网把路由选择协议分成两大类
1. 内部网关协议(ICP),域内路由选择,有RIP,OSPF
2. 外部网关协议(EGP),域间路由选择,有BGP




## 4.3 ipv4
### 4.3.1 ipv4 分组
...
#### ipv4 分组的格式
#### ip 数据报分片
当ip数据报的总长度大于链路MTU时,就需要将IP数据报中的数据分装在几个较小的IP数据报中,这些较小的数据报称为片

片在目的地网络层被重新组装

ip首部中的标志位有3比特,大拿只有后2比特有意义,分辨是MF位(more fragment) 和 DF位(Dont fragment)
只有DF=0时,该数据报才可以被分片
MF则用来告知目的主机该IP数据报是否为原始数据报的最后一个片
MF=1时表示还有后续的片


目的主机在对片进行重组时,使用片偏移字段来确定片应放在原始IP数据报的哪个位置

IP数据报首部长度20B,TCP也是
#### 网路层转发分组的流程
网络层的路由器执行的分组转发算法如下:
1. 从数据报的首部提取目的主机的IP地址D,得出目的网络地址N
2. 若网络N与此路由直接相连,则把数据报直接交付给目的主机D,这称为路由的直接交付,否则就是间接交付
3. 若路由表中有目的地址为D的特定主机路路由,则把数据报传送给下一跳路由
4. 若路由表中有到达网络N的路由,则报数据报传送给路由表指明的下一跳路由器,否则执行 步骤5
5. 若路由表中有一个默认路由,则波数据报传送给默认呢路由,否则执行 步骤6
6. 报告转发分组出错



### 4.3.2 ipv4 地址与NAT
#### ipv4 地址
传统的IP地址是分类的地址,分为A,B,C,D,E 五类
网络号,主机号
A 0,1~126,网络号到8b
B 10,128~191,网络号到16b
C 110,192~223,网络号到24b
D 1110,224~239,多播地址
E 1111,240~255,保留

主机号全0表示本网络本身
主机号全1表示本网络的广播地址,又称直接广播地址
127.0.0.0 保留为环路自检(Loopback Test),表示任意主机自身,
> on broadcast in loopback

32位全0 表示 本网络上的本主机(0.0.0.0)
32为全1 表示整个TCP/IP网络的广播地址,又称受限广播地址,等效为本网络的广播地址

用转发器或网桥等连接的若干LAN仍然是同一个网络,应此此LAN中所有IP地址的网络号必须相同




#### 网络地址转换
NAT 是指通过将专用网络地址转换为共用地址,从而对外隐藏内部管理的IP地址

私有IP网段如下(只在LAN中使用)
A类: 10.0 ~ 10.255
B类: 172.16 ~ 172.31
C类: 192.168.0 ~ 192.168.255

10.,172.(16~31).,192.168.(0~255).

路由器对私有地址的数据报一律不转发

NAT转换表中存放着{本地IP地址:端口}到{全球IP地址:端口的因设}


### 4.3.3 子网划分与子网掩码,CIDR
#### 子网划分

从1985年起,在IP地址中有增加了一个子网号字段,是两级IP地址变为了三级IP地址,这种做法称为子网划分

子网划分纯属一个单位内部的事情,单位对外仍然表现为没有划分子网的网络
从主机号借脱感比特作为子网号,
凡是从其他网络发送给本单位某台主机的IP数据报,
仍然根据IP数据报的目的网络号先找到连接本单位网络上的路由器
然后该路由器在收到IP数据报后,按目的网络号和子网络号找到目的子网,最后吧IP数据报直接交付给目的主机


> ipv4 子网划分 子网号不能全1或全0,CIDR没有限制
#### 子网掩码
...

#### 无分类域间路由选择(CIDR)
一种IP地址的划分方法

主要特点如下:
1. 使用 网络前缀代替子网络的概念;使用 斜线记法 ,即IP地址/前缀比特
2. 将网络前缀都相同的连续IP地址组成 CIDR地址块 
   1. 这种地址的聚合称为路由聚合或称为构成超网

优点在于前缀的灵活性

最长前缀匹配(最佳匹配): 使用CIDR时,路由表中每个项目由 网络前缀和 下一跳地址 组成,查找路由表时优先选 前缀最长的


### 4.3.4 ARP,DHCP,ICMP

#### ip地址与硬件地址
1. 在IP层抽象的互联网上只能看到IP数据报
2. 虽然在IP数据报首部中有完那正的源IP地址和目标IP地址,但路由器只根据目的IP地址的网络号进行路由选择
3. 在局域网的链路层只能看到MAC帧,IP数据报在被路由转发时,其数据链路层所用MAC地址是不断改变的
4. IP层屏蔽了下层的复杂细节

路由器由于互连多个网络,应此不仅有多个IP地址?,也有多个硬件地址


#### 地址解析协议(ARP)
每台主机都设有一个ARP高速缓存,用来存放本局域网上各主机和路由器的IP地址到MAC地址的映射表,称ARP表

MAC 全1 广播


#### 动态主机配置协议(DHCP)
用于给主机动态分配IP地址,提供了即插即用的互联网机制
应用层协议,基于UDP

1. DHCP 客户机广播 DHCP发现 消息后,试图找到网络中的DHCP服务器
2. DHCP服务器收到 DHCP发现 消息 向网络中广播 DHCP提供消息,其中包括提供DHCP客户机的IP地址和相关配置消息
3. DHCP客户机收到 DHCP提供 消息,如果接受DHCP服务器所提供的相关参数,拿么通过广播 DHCP请求 消息向DHCP服务器请求提供IP地址
4. DHCP服务器广播 DHCP确认 消息 将IP地址分配给DHCP客户机

DHCP客户机会得到多个应答消息,一般选最先到达的

DHCP服务器分配给DHCP客户的IP地址是临时的,称这段时间为租用期,一般有DHCP服务器决定,DHCP客户也可提出要求



#### 网际控制报文协议(ICMP)
为提高IP数据报交付成功的机会,在网络层使用了网际控制报文协议(ICMP),来让主机或路由报告差错和异常情况
是IP层协议

ICMP报文的种类有两种,即ICMP差错报文和ICMP询问报文
ICMP差错报文,用于目标主机或到目标主机路径上的路由器项源主机报告差错和异常情况,共有五种类型
1. 终点不可达,
2. 源点抑制(源抑制),当路由器或主机由于拥赛而丢弃数据报时,就向源点发送源点抑制报文
3. 时间超过,路由器收到TTL为零的数据报时,除丢弃该帧外,还要向源点发送时间超过报文
4. 参数问题,路由器或目的主机收到的数据报的首部有字段的值不正确时,丢弃该数据报,并向源点发送参数问题报文
5. 改变路由(重定向),路由器把改变路由报文发送给主机,让主机知道下次应将数据报发送给另外的路由器

不应发送ICMP差错报告报文的集中情况如下
1. 对ICMP差错报告不再发送ICMP差错报告报文
2. 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
3. 对有组播地址的数据报都不发送ICMP差错报告报文
4. 对具有特殊地址的数据不发送ICMP

ICMP 的两个常见应用是 ping和 traceroute

变长子网号?可能的最小子网?0,10,110


## 4.4 ipv6
### 4.4.1 ipv6 的主要特点
解决IP地址耗尽问题的措施有以下三种:
1. 采用无类别编址 CIDR 
2. 采用NAT节省IP
3. 采用IPV6

只有第三种方法从根本上解决了IP地址耗尽的问题

IPV6的主要特点如下:
1. 更大的地址空间,128bit,16B
2. 扩展的地址层次结构
3. 灵活的首部格式
4. 改进的选项
5. 允许协议继续扩充
6. 支持即插即用
7. 支持资源的预分配
8. IPV6只有在包的源节点才能分片,是端到端的.路由器接收不了就丢弃,发ICMP
9. IPV6首部长度必须是8B的整数倍
10. 增大了安全性

1. IPV6地址 用16B 表示
2. 简化了IP分组头,包含8个域
3. 更好的支持选项

取消了检验和字段



### 4.4.1 ipv6 地址 
IPV6数据报的目的地址可以是以下三种基本类型地址之一
1. 单播
2. 多播
3. 任播,一组计算机,通常是距离最近的一台计算机

三个等级
第一级(顶级)指明全球都知道的公共拓扑
第二级(场点级)指明单个场点
第三级指明单个网络接口

隧道技术是将整个IPV6数据报封装到IPV4数据报的数据部分



## 4.5 路由协议
### 4.5.1 自治系统
单一技术管理下的一组路由器

一个自治系统的所有路由器在本自治系统内都必须是连通的


### 4.5.2 域内路由与域间路由

IGP

EGP
### 4.5.3 路由信息协议(RIP)
ICP
#### RIP规定
1. 每个路由器都要维护从它到其他每个目的网络的距离记录
2. 距离也称跳数(Hop Count),规定从一个路由器到直接连接网络的距离为1,而每经过一个路由器距离加1
3. 优先选择跳数少的路径
4. 最多允许15跳,距离等于16表示网络不可达
5. 任意两个使用RIP的路由器之间每30s广播一次RIP路由更新信息,一遍自动建立并维护路由表(动态维护)
6. RIP中不支持子网掩码的RIP广播,所以RIP中每个网络的子网掩码必须相同.但在新的RIP2中,支持变长掩码和CIDR

#### RIP 的特点(与OSPF 比较)
1. 仅和相邻路由器交换信息
2. 交换当前路由器知道的全部信息
3. 固定时间间隔交换路由信息

所有路由指导了整个IP网络的路由表,称为RIP最终是收敛的

#### 距离向量算法
1. 对地址为X的相邻路由发来的RIP报文,先修改次报文中的所有项目,把下一跳字段的地址改为X,并把所有距离字段加1
2. 修改后来RIP报文中的每个项目
   1. 如果没有目的网络N,就添加到路由表中
   2. 当路由表中有网络N,且下一跳路由器的地址上X时,用收到的项目替换原来路由表中项目
   3. 当原来表中有网络N,但下一跳路由器的地址不是X时,比较距离,将距离小的项留下
3. 如果180秒还没收到相邻路由器的更新路由表,那把此相邻路由标记为不可达
4. 返回

优点: 简单,开销小,收敛快,
缺点:
1. 限制了网络规模
2. 网络规模越大,开销越大
3. 网络出现故障时,会出现慢收敛现象(坏消息传的慢)

应用层协议
UDP传送数据(端口 520)
### 4.5.4 开放最短路径有限(OSPF)协议
#### OSPF 协议的基本特点
与RIP相比有以下四种主要区别
1. 向本自治系统中所有路由器发送信息,使用洪泛法
2. 发送信息是与本路由器相邻的所哟路由器的链路状态,即本路由器和那些路由器相邻及该链路的度量
3. 只有当链路发生变化时,路由器才用洪泛法向所有路由器发送此消息,写更新收敛得快,而RIP只会定期交换信息
4. OSPF是网络层协议,直接用IP数据报传输,(协议字段 89)

除此以外,OSPF还有以下特点:
1. OSPF对不同的链路可根据IP分组的不同服务类型(TOS)而设置成不同的代价.应四,OSPF对不同类型的业务可计算出不同的路由,十分灵活
2. 多路径间的负载平衡
3. OSPF路由器之间交换的分组都有鉴别功能,因此保证了仅在可信赖的路由器之间交换链路状态信息
4. 支持CIDR,可变长度的子网划分
5. 每条链路转态都带上一个32位的序列号,序号越大,状态就越新


#### OSPF 的基本工作原理
所有的路由器最终都能建立一个链路状态数据库,
根据这个数据库(全网的拓扑结构图),使用Dijkstra 最短路径算法计算更新最后路径(下一跳)
以此构建自己的路由表

此后当链路状态发生变换时,每隔路由重新计算到各目的网络的最优路径,构造新的路由表

区域,洪泛法交换链路信息局限在每隔区域而非整个自治系统
主干区域


#### OSPF 的五种分组类型
1. 问候分组,发现和维持邻站的可达性
2. 数据库描述分组,向邻站给出自己的链路状态数据库中的所有项目的摘要信息
3. 链路状态请求分组,向对发发送请求某种链路状态项目的详细信息
4. 链路状态更新分组,用洪泛法对全网更新链路信息
5. 链路状态确认分组,对链路更新分组进行确认

通常每隔10秒,每两个相邻的路由器要交换一次问候分组

在路由器刚开始工作时,OSPF让每个路由器使用数据库描述分组和相邻路由交换本数据库中已有链路摘要信息,
然后路由器使用链路状态请求分组,向对发请求发送自己所缺少的某些链路状态项目信息
经过一段时间的分组交换,就建立了全网同步的链路数据库

为确保链路状态数据库与全网的状态保持一致,OSPF还规定每隔一定时间(如30分钟),就刷新一次数据库中的链路状态

### 4.5.5 边界网关协议(BGP)
不同自治系统的路由器之极拿交换路由信息的协议,是一种外部网关协议

GCP使用环境问题:
1. 互联网规模太大,使自治系统之间路由选择非常困难
2. 对于自治系之间的路由选择,要寻找最佳路由是很不现实的
3. 自治系统之间的路由选择必须考虑有关策略

边界网关协议(BGP)只能力求寻找一条能够到达目的网络且比较好的路由
BGP采用的是**路径向量**路由选择协议,应用层协议,基于TCP

工作原理:
1. 每个自治系统的管理员要选择至少一个路由器(可以有多个)作为该自治系统的 BGP发言人
2. 一个BGP发言人与其他自治系统中的BGP发言人要交换路由信息,就要先建立TCP连接
3. 然后在此连接上交换BGP报文以建立BGP会话,再利用BGP会话交换路由信息
4. 当所有BGP发言人都相互交换网络可达性信息后,各BGP发言人就可找出各个自治系统的较好路由
5. 每隔BGP发言人除必须运行BGP外,还必须运行该AS所用的内部网关协议

BGP特点:
1. 节点(自治系统)少
2. BGP发言人少
3. 支持CIDR,路由表包括网络前最,下一条路由,到达该网络所要经过的各个自治系统序列
4. BGP刚运行时,邻站交换整个BGP路由表,但以后值更新变化部分



BGP-4 公式用4种报文
1. 打开,用来与相邻的另一个BGP发言人建立关系
2. 更新,发送某一路由的信息,以及列出要撤销的多条路由
3. 保活,确认打开报文并周期性地证实邻站关系
4. 通知报文,用来发送检测到的差错


## 4.6 ip组播
### 5.6.1 组播的概念
使用组播组概念,D类地址

主机使用一个称为IGMP(因特网组管理协议)的协议加入组播组

主机组播时仅发送一份数据,只有数据在传播路径出现分叉时才将分组复制后继续转发

能够运行组播协议的路由器称为组播路由器


### 5.6.2 ip组播地址
D类地址方位 224.0.0.0~239.255.255.255,每个D类IP地址标志一个组播组

组播数据报和一般的IP数据报的区别是,前者使用D类IP地址作为目的地址,并且首部中部的协议字段值是2,表明使用IGMP,,需要注意的是:
1. 组播数据报 尽最大努力交付,不提供可靠交付
2. 组播地址只能用于目的地址,而不能用于源地址
3. 组播数据报不产生ICMP差错报文
4. 并非所有D类地址都可作为组播地址

IP组播可以分成两种,
一种只在本局域网进行硬件组播
另一种则在因特网的范围进行组播,在因特网组播的最后阶段,还是要把组播数据报在局域网上用硬件组播交付给组播组所有成员



### 5.6.3 IGMP与组播路由算法

IGMP让连接到本地局域网上的组播路由器知道本局域网上是否有主机参加或退出了某个组播组

IGMP应视为TCP/IP的一部分

...

TTL字段防止环路


## 4.7 移动ip
### 4.7.1 移动ip的概念
支持移动性的因特网体系结构与协议称为移动IP

移动IP技术是指移动节点以固定的网络IP地址实现跨越不同网段的漫游功能,并保证权限不改变


### 4.7.1 移动ip通信过程
在移动ip中,每个移动节点都有一个唯一的本地地址
,节点移动时,本地地址不变,
在本地网络链路上每隔本地节点还必须有一个本地代理来为它维护当前的位置信息
转交地址用来标识移动节点现在所处的位置,方便路由选择

移动节点与当前转交地址的联合称为移动绑定或绑定

通信流程如下:
1. 移动节点在本地网是,按传统TCP/IP方式通信
2. 漫游外地节点时,需要项本地代理注册当前位置,这个位置地址就是转交地址
3. 本地代理收到来自转交地址的注册后,会构建一条通线转交地址的隧道,将解惑的发给移动节点的IP分组通过隧道送到转交地址
4. 在转交地址出解除隧道封装,恢复原始IP分组,最后送到移动节点,

...





## 4.8 网路层设备
### 4.8.1 路由器的组成与功能
路由器是一种具有多个输入/输出端口的专用计算机,其任务是连接不同的网络,并完成路由转发,在多个逻辑网络互联是必须使用路由器

从结构上来看,路由器有路由选择和分组转发两部分构成
而从模型的角度来看,路由器是网络层设备,它实现了网络模型的下三层即物理层,数据链路层和网络层
有转发表

### 4.8.2 路由表与路由转发

分组的实际转发靠直接查找转发表,而不是直接查找路由表

转发表中,含有一个分组将要发往的目的地址,以及分组的下一条(MAC地址)
为减少转发表的重复项目,可以使用一个默认路由替代所有具有相同 下一跳(另一个路由的内容?),并将默认路由设置得比其他项目的优先级低



## 4.9 本章小结及疑难点

网关和路由器是同义词

广域网中分组的最大长度可知,所以不用分片

